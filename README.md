# Passenger Release Bot

passenger-release-bot is a chat bot that monitors the release state of the mytaxi Passenger app.

### How it works

It is built on the [Hubot][hubot] framework, and was
initially generated by [generator-hubot][generator-hubot].

It runs a Ruby script that uses Fastlane's [Spaceship][spaceship-repository]
to periodically retrieve the app information from iTunes Connect.

The Ruby script retrieves the information and writes it to a JSON file
(`app-version.json`).

The bot then parses the JSON and posts a Slack message.

[hubot]: http://hubot.github.com
[generator-hubot]: https://github.com/github/generator-hubot
[spaceship-repository]: https://github.com/fastlane/fastlane/tree/master/spaceship

### Running the bot locally

You can test your hubot by running the following, however some plugins will not
behave as expected unless the [environment variables](#configuration) they rely
upon have been set.

You can start passenger-release-bot locally by running:

    % HUBOT_SLACK_TOKEN=xoxb-XXXXXXXXXXXX-XXXXXXXXXXXX-XXXXXXXXXXXXXXXXXXXXXXXX \
      HUBOT_ITUNES_CONNECT_USERNAME="mail@example.com" \
      HUBOT_BUNDLE_ID="com.example.app"Â \
      HUBOT_ROOM_NAME="release-notifications" \
      \./bin/hubot --adapter slack

You'll see some start up output and a prompt:

    [Sat Feb 28 2015 12:38:27 GMT+0000 (GMT)] INFO Using default redis on localhost:6379
    passenger-release-bot>

Then you can interact with passenger-release-bot by typing `passenger-release-bot help`.

    passenger-release-bot> passenger-release-bot help
    passenger-release-bot animate me <query> - The same thing as `image me`, except adds [snip]
    passenger-release-bot help - Displays all of the help commands that passenger-release-bot knows about.
    ...

### Configuration

#### Environment variables

A few scripts (including some installed by default) require environment
variables to be set as a simple form of configuration.

- `HUBOT_SLACK_TOKEN`: OAuth token of the bot user ([learn more][how-to-get-slack-token])
- `HUBOT_ITUNES_CONNECT_USERNAME`: The username of the user that manages the app
- `HUBOT_BUNDLE_ID`: The bundleId of the app to monitor
- `HUBOT_ROOM_NAME`: The room in which the bot posts the updates.

Make sure you invite the bot user to the room, or otherwise it'll not be able to post regular updates.

[how-to-get-slack-token]: https://slackapi.github.io/hubot-slack/#getting-a-slack-token

### Development

The bot requires a Redis server as the "brain". On macOS, install it using

    % brew install redis

Run the redis server with

    % redis-server /usr/local/etc/redis.conf

#### Running the Ruby script standalone

In order to debug the Ruby script that downloads the app details,
you can also run it directly:

    % ruby update_app_version_json.rb \
        --username "mail@example.com" \
        --bundle_id "com.example.app" \
        --destination "app-version.json"

Please refer to the script for the documentation of the parameters.
